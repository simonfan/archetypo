//     archetypo
//     (c) simonfan
//     archetypo is licensed under the MIT terms.

define("__archetypo/parse/value",["require","exports","module"],function(e,r,t){function a(e){return"["+e+"]"}function o(e){var r={};return e?e[2]?(r.type="invocation",r.priority=""===e[1]?"0":e[1],r.method=e[2],r.value=a(e[3])):e[4]&&(r.type="value",r.priority=e[1],r.value=e[4]):r.type="empty",r}var n="\\s*",i="(?:(\\d*)!)?",u="([\\w$.\\-/]*)",c=":"+n+"(.*)"+n,p=["^",n,i,n,"(?:",u,n,c,"|","(.*?)",")",n,"$"].join(""),l=new RegExp(p);t.exports=function(e){if(_.isString(e)){e=e.replace(/\n/g,"");var r=e.match(l);return o(r)}return{type:"value",value:e}}}),define("__archetypo/build/data",["require","exports","module","lodash","jquery-meta-data","../parse/value"],function(e,r,t){var a=(e("lodash"),e("jquery-meta-data"),e("../parse/value"));t.exports=function(e,r){return e.metaData({prefix:r.namespace,parse:a,replace:!1})}}),define("__archetypo/auxiliary",["require","exports","module","lodash"],function(e,r){e("lodash");r.camelCase=function(e){return e.replace(/-(.)/g,function(e,r){return r.toUpperCase()})},r.closestAncestor=function(e,r){return e.parent().closest(r)}}),define("__archetypo/build/evaluation/invoke",["require","exports","module","q","deep","../../auxiliary"],function(e,r,t){function a(e,r){var t=e.evaluate("$"+n.camelCase(r));return _.isFunction(t)?o(t):e.load(r)}var o=e("q"),n=(e("deep"),e("../../auxiliary"));t.exports=function(e,r){return a(e,r.method).then(function(t){var a=e.evaluate(r.value),n=t.apply(e,a);return o.isPromise(n)?n:o(n)})}}),define("__archetypo/build/evaluation/index",["require","exports","module","lodash","q","_q","./invoke"],function(e,r,t){function a(e,r){var t=i.reduce(r,function(r,t,a){return"value"===t.type&&(r[a]=e.evaluate(t.value)),r},{});e.assign(t);var a=i.pick(r,function(e){return"invocation"===e.type});return c.mapValues(a,function(r,t){return p(e,r,t)}).then(function(r){return e.assign(r),e})}function o(e,r){var t=i.unique(i.pluck(r,"priority")).sort(function(e,r){return e-r}),o=i.map(t,function(t){var o=i.pick(r,function(e){return e.priority===t});return i.partial(a,e,o)});return o}function n(e){return i.reduce(e,function(e,r){return e.then(r)},u())}var i=e("lodash"),u=e("q"),c=e("_q"),p=e("./invoke");t.exports=function(e,r,t){var a=o(r,t),c=e?e.data("archetypo-evaluation-promise"):u(!0);return c.then(i.partial(n,a))}}),define("__archetypo/arch-scope/methods",["require","exports","module","lodash","q","deep","scope"],function(e,r){{var t=e("lodash"),a=e("q"),o=e("deep");e("scope")}r.load=function(r,n){var i=a.defer();return t.isString(r)?n?e([r],function(e){i.resolve(o.get(e,n))},i.reject):e([r],i.resolve,i.reject):t.isArray(r)&&e(r,function(){var e=t.toArray(arguments);i.resolve(n?t.map(e,function(e){return o.get(e,n)}):e)},i.reject),i.promise},r.l=r.load}),define("__archetypo/arch-scope/index",["require","exports","module","jquery","scope","./methods"],function(e,r,t){var a=e("jquery"),o=e("scope"),n={enumerable:!1},i=t.exports=o.extend();i.assignProto(e("./methods"),n),a.prototype.archetypo=function(){var e=this.data("archetypo");return e?e:i({el:this})}}),define("__archetypo/build/scope",["require","exports","module","../arch-scope/index","../auxiliary"],function(e,r,t){{var a=e("../arch-scope/index");e("../auxiliary")}t.exports=function(e,r,t,o){var o=o||{};o.el=r;var n;if(e&&0!==e.length){var i=e.data("archetypo");n=i?e.data("archetypo").create(o):a(o)}else n=a(o);return n}}),define("archetypo",["require","exports","module","jquery","lodash","q","./__archetypo/build/data","./__archetypo/build/evaluation/index","./__archetypo/build/scope","./__archetypo/auxiliary"],function(e,r,t){function a(e,r){var t=e.find(r.selector),a=i.map(t,function(e){return o(n(e),null,r),n(e).data("archetypo-evaluation-promise")});return u.all(a)}function o(e,r,t){var o=e.data("archetypo-promise");if(!o){t=t||{},i.defaults(t,d),t.selector=i.isFunction(t.selector)?t.selector(t.namespace):t.selector,t.rootSelector=i.isFunction(t.rootSelector)?t.rootSelector(t.namespace):t.rootSelector;var n;if(!e.is(t.rootSelector)){var n=s.closestAncestor(e,t.selector);n=1===n.length?n:void 0}var u=c(e,t),f=l(n,e,t,r);e.data("archetypo",f);var v=p(n,f,u);e.data("archetypo-evaluation-promise",v);var o=a(e,t).then(function(){return f});e.data("archetypo-promise",o)}return o}var n=e("jquery"),i=e("lodash"),u=e("q"),c=e("./__archetypo/build/data"),p=e("./__archetypo/build/evaluation/index"),l=e("./__archetypo/build/scope"),s=e("./__archetypo/auxiliary"),d={namespace:"arch",selector:function(e){return"[data-"+e+"]"},rootSelector:function(e){return"[data-"+e+"-root]"}};o.setDefaults=function(e,r){i.isObject(e)?i.each(e,function(e,r){d[r]=e}):d[e]=r},t.exports=o});