//     subject
//     (c) simonfan
//     subject is licensed under the MIT terms.

//     Q
//     (c) simonfan
//     Q is licensed under the MIT terms.

//     archetypo
//     (c) simonfan
//     archetypo is licensed under the MIT terms.

define("subject",["lodash"],function(e){var t={initialize:function(){}},o=function(){};return o.prototype=t,o.proto=function(t,o){return e.isObject(t)?e.assign(this.prototype,t):this.prototype[t]=o,this},o.protoMerge=function(t,o){if(e.isString(t)){var r=this.prototype[t],s=e.assign({},r,o);this.proto(t,s)}else e.each(t,e.bind(function(e,t){this.protoMerge(t,e)},this))},o.extend=function(t,o,r){var s,n;e.isFunction(t)?(s=e.assign({},o,{initialize:t}),n=r):e.isObject(t)&&(s=t||{},n=r);var a,i=this;return a=function(){var e=Object.create(a.prototype);return e.initialize.apply(e,arguments),e},e.assign(a,i,n),a.prototype=Object.create(i.prototype),a.prototype.constructor=a,a.proto(s),a.__super__=i.prototype,a},o.extend.bind(o)}),define("__archetypo/data/parse",["require","exports","module","lodash"],function(e,t,o){function r(e){return new RegExp("^"+e+"([A-Z].*$)")}function s(e){return e.charAt(0).toLowerCase()+e.slice(1)}function n(e){return e.charAt(0).toUpperCase()+e.slice(1)}function a(e){var t=e.match(l);return{processor:t[1],value:t[2]}}function i(e,t){var o=r(e);return u.transform(t,function(e,t,r){var n=r.match(o);if(n){var i=s(n[1]);e[i]=a(t)}})}function c(e,t){var o=new RegExp("^"+e+"([A-Z].*?)?Fn$"),r=[];return u.each(t,function(e,t){var n=t.match(o);if(n){var a=n[1]||"";r.push(s(a))}}),r}var u=e("lodash"),l=/^(?:(.*?)\s*:\s*)?(.*)$/;o.exports=function(e,t){console.log("parseArchData"),console.log(t.namespaces);var o=t.prefix,r=c(o,e);r=u.union(r,t.namespaces);var s={};return u.each(r,function(t){var r=o+n(t),a=i(r,e);u.size(a)>0&&(s[t]=a)}),s},t.namespaces=c,t.value=a}),define("_q",["require","exports","module","lodash","q"],function(e,t){var o=e("lodash"),r=e("q");t.each=function(){},t.map=function(){var e=o.map.apply(o,arguments);return r.all(e)},t.mapValues=function(e){var t=o.keys(e),s=o.map.apply(o,arguments);return r.all(s).then(function(e){return o.zipObject(t,e)})}}),define("__archetypo/data/process/property",["require","exports","module","lodash","q"],function(e,t,o){function r(e,t,o){var r=t.processor||s.find(o.defaultProcessors,function(t,o){var r=new RegExp(o);return r.test(e)});if(r){if(s.isString(r)){if(r=o.processors[r],!r)throw new Error("No processor named "+r+" was found. Make sure it exists");return r}return r}return!1}var s=e("lodash"),n=e("q");o.exports=function(e,t,o){console.log("processProperty invoked on "+e);var s=n.defer();console.log(t.value);var a=o.evaluator.call(o.context,t.value);console.log("1!!!!!!!!!!!! "+e),console.log(a);var i=r.apply(this,arguments);return i?1===i.length?s.resolve(i.call(o.context,a)):2===i.length&&i.call(o.context,a,s.resolve):s.resolve(a),s.promise}}),define("__archetypo/data/process/index",["require","exports","module","lodash","q","_q","./property"],function(e,t,o){function r(e,t,o){return s.extend(t,o.defaultProperties),n.mapValues(t,function(e,t){return a(t,e,o)},this)}var s=e("lodash"),n=(e("q"),e("_q")),a=e("./property");o.exports=function(e,t){return n.mapValues(e,function(e,o){return r(o,e,t)},this)}}),define("__archetypo/build/build-namespaces",["require","exports","module","lodash","q","../data/parse","../data/process/index"],function(e,t,o){var r=e("lodash"),s=e("q"),n=e("../data/parse"),a=e("../data/process/index");o.exports=function(){console.log("buildNamespaces invoked"),console.log(this.scope.availableNames);var e=s.defer(),t=n(this.el.data(),{prefix:this.prefix,namespaces:this.scope.availableNames}),o={context:this.el,evaluator:this.evaluator,processors:this.processors,defaultProcessors:this.defaultProcessors,defaultProperties:this.defaultProperties},i=a(t,o);return i.done(r.bind(function(t){r.each(t,function(e,t){this.scope.build(t,e)},this),console.log("namespaces built"),e.resolve()},this)),e.promise}}),define("__archetypo/build/build-invoke-fns",["require","exports","module","lodash","q","_q"],function(e,t,o){function r(e,t){console.log("invokeFn"),console.log(e);var o=n.defer(),r=e.fn;if(!s.isFunction(r))throw new Error("There is no function(fn) for "+t+" namespace.");var a=s.create(e);a.fn=void 0;var i=r.call(this.el,a);return n.isPromise(i)?i.done(o.resolve):o.resolve(i),o.promise}var s=e("lodash"),n=e("q"),a=e("_q");o.exports=function(){console.log("invokeAllFns invoked");var e=n.defer();console.log("!!!"),console.log(this.scope.namespaces);var t=a.mapValues(this.scope.namespaces,s.bind(r,this));return t.done(s.bind(function(t){this.fns=t,e.resolve()},this)),e.promise}}),define("__archetypo/build/build-subs",["require","exports","module","lodash","jquery","q"],function(e,t,o){var r=e("lodash"),s=e("jquery"),n=e("q");o.exports=function(){console.log("buildSubs invoked");var e=n.defer(),t=this.el.find("[data-archetypo]"),o=r.map(t,function(e){e=s(e);var t=e.data("archetypo");if(r.isObject(t))return t.promise;var o=this.constructor(e,this.options);return o.promise},this);return n.all(o).done(function(){e.resolve()}),e.promise}}),define("__archetypo/build/index",["require","exports","module","lodash","jquery","q","./build-namespaces","./build-invoke-fns","./build-subs"],function(e,t,o){var r=e("lodash"),s=(e("jquery"),e("q")),n=e("./build-namespaces"),a=e("./build-invoke-fns"),i=e("./build-subs");o.exports=function(){var e=this,t=s.defer();return n.call(this).then(r.bind(a,this)).then(r.bind(i,this)).done(function(){t.resolve(e)}),t.promise}}),define("__archetypo/scope-manager",["require","exports","module","lodash","subject"],function(e,t,o){var r=e("lodash"),s=e("subject");o.exports=s({initialize:function(e){this.parent=e.parent,console.log("scope parent"),console.log(this.parent),this.namespaces={},this.availableNames=this.parent?r.clone(this.parent.availableNames):[],console.log("scope initial availableNames"),console.log(r.clone(this.parent.availableNames)),console.log(this.availableNames)},get:function(e){console.log("scope get "+e);var t=this.namespaces[e];return t||(t=this.parent.namespaces.get(e)),t},build:function(e,t){console.log("scope build "+e);var o;return this.parent&&r.isObject(this.parent.get(e))?o=r.create(this.parent.get(e)):(this.availableNames.push(e),o={},console.log(this.availableNames)),r.extend(o,t),this.namespaces[e]=o,this}})}),define("archetypo",["require","exports","module","lodash","jquery","subject","q","./__archetypo/build/index","./__archetypo/scope-manager"],function(e,t,o){function r(e,t){return t=t||"main",e.data(storage)[t]}function s(e,t){return t=t||{},n.defaults(t,defaultOptions),storage=t.storage=t.storage||storage,buildEl(e,t)}{var n=e("lodash"),a=e("jquery"),i=e("subject"),c=(e("q"),e("./__archetypo/build/index")),u=e("./__archetypo/scope-manager");o.exports=i({prefix:"arch",fns:{},evaluator:function(e){return"this"===e?this:e},processors:{require:function(t,o){console.log("required "+t),e([t],function(e){o(e)})}},defaultProcessors:{fn:"require"},defaultProperties:{el:{processor:void 0,value:"this"}},initialize:function(e,t){t=t||{},e.data("archetypo",this),this.el=e;var o=e.parent().closest("[data-archetypo]");this.parent=o.data("archetypo"),n.each(n.pick(t,["processors","defaultProcessors"]),function(e,t){n.extend(this[t],e)},this),this.evaluator=t.evaluator||this.evaluator,this.scope=u({parent:this.parent?this.parent.scope:!1}),this.promise=c.call(this)},namespace:function(e){return this.namespaces[e]}})}a.prototype.archetypo=function(){var e=this.data("__archetypo-initialized");return e&&(0===arguments.length||n.isString(arguments[0]))?r(this,arguments[0]):(this.data("__archetypo-initialized",!0),s(this,arguments[0]))}});