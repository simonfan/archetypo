//     subject
//     (c) simonfan
//     subject is licensed under the MIT terms.

//     Q
//     (c) simonfan
//     Q is licensed under the MIT terms.

//     archetypo
//     (c) simonfan
//     archetypo is licensed under the MIT terms.

define("subject",["lodash"],function(e){var t={initialize:function(){}},r=function(){};return r.prototype=t,r.proto=function(t,r){return e.isObject(t)?e.assign(this.prototype,t):this.prototype[t]=r,this},r.protoMerge=function(t,r){if(e.isString(t)){var o=this.prototype[t],s=e.assign({},o,r);this.proto(t,s)}else e.each(t,e.bind(function(e,t){this.protoMerge(t,e)},this))},r.extend=function(t,r,o){var s,n;e.isFunction(t)?(s=e.assign({},r,{initialize:t}),n=o):e.isObject(t)&&(s=t||{},n=o);var a,i=this;return a=function(){var e=Object.create(a.prototype);return e.initialize.apply(e,arguments),e},e.assign(a,i,n),a.prototype=Object.create(i.prototype),a.prototype.constructor=a,a.proto(s),a.__super__=i.prototype,a},r.extend.bind(r)}),define("__archetypo/data/parse",["require","exports","module","lodash"],function(e,t,r){function o(e){return new RegExp("^"+e+"([A-Z].*$)")}function s(e){return e.charAt(0).toLowerCase()+e.slice(1)}function n(e){return e.charAt(0).toUpperCase()+e.slice(1)}function a(e){var t=e.match(p);return{processor:t[1],value:t[2]}}function i(e,t){var r=o(e);return c.transform(t,function(e,t,o){var n=o.match(r);if(n){var i=s(n[1]);e[i]=a(t)}})}function u(e,t){var r=new RegExp("^"+e+"([A-Z].*?)?Fn$"),o=[];return c.each(t,function(e,t){var n=t.match(r);if(n){var a=n[1]||"";o.push(s(a))}}),o}var c=e("lodash"),p=/^(?:(.*?)\s*:\s*)?(.*)$/;r.exports=function(e,t){var r=t.prefix,o=u(r,e);o=c.union(o,t.namespaces);var s={};return c.each(o,function(t){var o=r+n(t),a=i(o,e);c.size(a)>0&&(s[t]=a)}),s},t.namespaces=u,t.value=a}),define("_q",["require","exports","module","lodash","q"],function(e,t){var r=e("lodash"),o=e("q");t.each=function(){},t.map=function(){var e=r.map.apply(r,arguments);return o.all(e)},t.mapValues=function(e){var t=r.keys(e),s=r.map.apply(r,arguments);return o.all(s).then(function(e){return r.zipObject(t,e)})}}),define("__archetypo/data/process/property",["require","exports","module","lodash","q"],function(e,t,r){function o(e,t,r){var o=t.processor||s.find(r.defaultProcessors,function(t,r){var o=new RegExp(r);return o.test(e)});if(o){if(s.isString(o)){if(o=r.processors[o],!o)throw new Error("No processor named "+o+" was found. Make sure it exists");return o}return o}return!1}var s=e("lodash"),n=e("q");r.exports=function(e,t,r){console.log("processProperty invoked on "+e);var s=n.defer();console.log(t.value);var a=r.evaluator.call(r.context,t.value);console.log("1!!!!!!!!!!!! "+e),console.log(a);var i=o.apply(this,arguments);return i?1===i.length?s.resolve(i.call(r.context,a)):2===i.length&&i.call(r.context,a,s.resolve):s.resolve(a),s.promise}}),define("__archetypo/data/process/index",["require","exports","module","lodash","q","_q","./property"],function(e,t,r){function o(e,t,r){return s.extend(t,r.defaultProperties),n.mapValues(t,function(e,t){return a(t,e,r)},this)}var s=e("lodash"),n=(e("q"),e("_q")),a=e("./property");r.exports=function(e,t){return n.mapValues(e,function(e,r){return o(r,e,t)},this)}}),define("__archetypo/build/build-namespaces",["require","exports","module","lodash","q","../data/parse","../data/process/index"],function(e,t,r){var o=e("lodash"),s=e("q"),n=e("../data/parse"),a=e("../data/process/index");r.exports=function(){console.log("buildNamespaces invoked"),console.log(this.scope.availableNames);var e=s.defer(),t=n(this.el.data(),{prefix:this.prefix,namespaces:this.scope.availableNames}),r={context:this.el,evaluator:this.evaluator,processors:this.processors,defaultProcessors:this.defaultProcessors,defaultProperties:this.defaultProperties},i=a(t,r);return i.done(o.bind(function(t){o.each(t,function(e,t){this.scope.build(t,e)},this),console.log("namespaces built"),e.resolve()},this)),e.promise}}),define("__archetypo/build/build-invoke-fns",["require","exports","module","lodash","q","_q"],function(e,t,r){function o(e,t){console.log("invokeFn"),console.log(e);var r=n.defer(),o=e.fn;if(!s.isFunction(o))throw new Error("There is no function(fn) for "+t+" namespace.");var a=s.create(e);a.fn=void 0;var i=o.call(this.el,a);return n.isPromise(i)?i.done(r.resolve):r.resolve(i),r.promise}var s=e("lodash"),n=e("q"),a=e("_q");r.exports=function(){console.log("invokeAllFns invoked");var e=n.defer();console.log("!!!"),console.log(this.scope.namespaces);var t=a.mapValues(this.scope.namespaces,s.bind(o,this));return t.done(s.bind(function(t){this.fns=t,e.resolve()},this)),e.promise}}),define("__archetypo/build/build-subs",["require","exports","module","lodash","jquery","q"],function(e,t,r){var o=e("lodash"),s=e("jquery"),n=e("q");r.exports=function(){console.log("buildSubs invoked");var e=n.defer(),t=this.el.find("[data-archetypo]"),r=o.map(t,function(e){e=s(e);var t=e.data("archetypo");if(o.isObject(t))return t.promise;var r=this.constructor(e,this.options);return r.promise},this);return n.all(r).done(function(){e.resolve()}),e.promise}}),define("__archetypo/build/index",["require","exports","module","lodash","jquery","q","./build-namespaces","./build-invoke-fns","./build-subs"],function(e,t,r){var o=e("lodash"),s=(e("jquery"),e("q")),n=e("./build-namespaces"),a=e("./build-invoke-fns"),i=e("./build-subs");r.exports=function(){var e=this,t=s.defer();return n.call(this).then(o.bind(a,this)).then(o.bind(i,this)).done(function(){t.resolve(e)}),t.promise}}),define("__archetypo/scope-manager",["require","exports","module","lodash","subject"],function(e,t,r){var o=e("lodash"),s=e("subject");r.exports=s({initialize:function(e){this.parent=e.parent,this.namespaces={},this.availableNames=this.parent?o.clone(this.parent.availableNames):[]},get:function(e){var t=this.namespaces[e];return t||(t=this.parent.namespaces.get(e)),t},build:function(e,t){var r;return this.parent&&o.isObject(this.parent.get(e))?r=o.create(this.parent.get(e)):(this.availableNames.push(e),r={}),o.extend(r,t),this.namespaces[e]=r,this}})}),define("archetypo",["require","exports","module","lodash","jquery","subject","q","./__archetypo/build/index","./__archetypo/scope-manager"],function(e,t,r){function o(e,t){return t=t||"main",e.data(storage)[t]}function s(e,t){return t=t||{},n.defaults(t,defaultOptions),storage=t.storage=t.storage||storage,buildEl(e,t)}{var n=e("lodash"),a=e("jquery"),i=e("subject"),u=(e("q"),e("./__archetypo/build/index")),c=e("./__archetypo/scope-manager");r.exports=i({prefix:"arch",fns:{},evaluator:function(e){return"this"===e?this:e},processors:{require:function(t,r){console.log("required "+t),e([t],function(e){r(e)})}},defaultProcessors:{fn:"require"},defaultProperties:{el:{processor:void 0,value:"this"}},initialize:function(e,t){t=t||{},e.data("archetypo",this),this.el=e;var r=e.parent().closest("[data-archetypo]");this.parent=r.data("archetypo"),n.each(n.pick(t,["processors","defaultProcessors"]),function(e,t){n.extend(this[t],e)},this),this.evaluator=t.evaluator||this.evaluator,this.scope=c({parent:this.parent?this.parent.scope:!1}),this.promise=u.call(this)},namespace:function(e){return this.namespaces[e]}})}a.prototype.archetypo=function(){var e=this.data("__archetypo-initialized");return e&&(0===arguments.length||n.isString(arguments[0]))?o(this,arguments[0]):(this.data("__archetypo-initialized",!0),s(this,arguments[0]))}});