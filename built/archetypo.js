//     archetypo
//     (c) simonfan
//     archetypo is licensed under the MIT terms.

define("__archetypo/build/subs",["require","exports","module","q","_q","jquery","lodash"],function(e,r,t){function o(e){var r=n(e),t=r.data("archetypo");if(!t||!i.isObject(t)){var o=r.parent().closest(this.archSelector),a=o.data("archetypo");if(!a)throw console.log("no ancestorArch"),new Error("No ancestor for sub-archetypo.");t=a.childArchetypo({el:r})}return t.promise}var a=e("q"),n=(e("_q"),e("jquery")),i=e("lodash");t.exports=function(){var e=this.el.find(this.archSelector),r=i.map(e,o,this),t=this,n=a.all(r);return n.fail(this.error),n.then(function(){return t})}}),define("__archetypo/child-archetypo",["require","exports","module","scope"],function(e,r,t){e("scope");t.exports=function(e){var r=this.create(e);return r.archInit(),r}}),define("__archetypo/parse/value",["require","exports","module"],function(e,r,t){function o(e){return"["+e+"]"}function a(e){var r={};return e?e[2]?(r.type="invocation",r.priority=""===e[1]?"0":e[1],r.method=e[2],r.value=o(e[3])):e[4]&&(r.type="value",r.value=e[4]):r.type="empty",r}var n="\\s*",i="(?:(\\d*)!)?",s="([\\w$\\-]*)",h=":"+n+"(.*)"+n,c=["^",n,"(?:",i,n,s,n,h,"|","(.*?)",")",n,"$"].join(""),u=new RegExp(c);t.exports=function(e){var r=e.match(u);return a(r)}}),define("__archetypo/methods/data",["require","exports","module","lodash","jquery-meta-data","../parse/value"],function(e,r){var t=e("lodash"),o=(e("jquery-meta-data"),e("../parse/value"));r.archData=function(){var e=t.toArray(arguments),r=e.shift()||{};return t.defaults(r,this.archDataOptions),e.unshift(r),this.el.metaData.apply(this.el,e)},r.archDataOptions={prefix:"arch",parse:o,replace:!1}}),define("__archetypo/helpers",["require","exports","module","lodash"],function(e,r){e("lodash");r.camelCase=function(e){return e.replace(/-(.)/g,function(e,r){return r.toUpperCase()})}}),define("__archetypo/methods/arch-evaluate/invoke",["require","exports","module","q","../../helpers"],function(e,r,t){var o=e("q"),a=e("../../helpers");t.exports=function(e){var r=a.camelCase(e.method),t=this.invoke(r,e.value);return t=o.isPromise(t)?t:o(t),t.fail(this.error),t}}),define("__archetypo/methods/arch-evaluate/index",["require","exports","module","lodash","q","_q","./invoke"],function(e,r){function t(e){var r=o.reduce(e,function(e,r,t){return"value"===r.type&&(e[t]=this.evaluate(r.value)),e},{},this);this.assign(r);var t=o.pick(e,function(e){return"invocation"===e.type});return n.mapValues(t,i,this).then(o.bind(function(e){return this.assign(e),this},this)).fail(this.error)}var o=e("lodash"),a=e("q"),n=e("_q"),i=e("./invoke");r.archEvaluate=function(e){var r=o.unique(o.pluck(e,"priority")).sort(function(e,r){return e-r}),n=o.map(r,function(r){var a=o.pick(e,function(e){return e.priority===r});return o.partial(o.bind(t,this),a)},this),i=o.reduce(n,function(e,r){return e.then(r)},a()),s=this;return i.then(function(){return s}).fail(this.error),i}}),define("__archetypo/methods/index",["require","exports","module","lodash","q","deep"],function(e,r){var t=e("lodash"),o=e("q"),a=e("deep");r.load=function(r,n){var i=o.defer();return t.isString(r)?n?e([r],function(e){i.resolve(a.get(e,n))}):e([r],i.resolve):t.isArray(r)&&e(r,function(){var e=t.toArray(arguments);i.resolve(n?t.map(e,function(e){return a.get(e,n)}):e)}),i.promise},r.summon=function(e){var r=Array.prototype.slice.call(arguments,1);return r=r&&r.length>0?r:[this],this.load(e).done(t.bind(function(e){e.apply(this,r)},this))},r.l=r.load,r.s=r.summon}),define("archetypo",["require","exports","module","lodash","jquery","scope","q","./__archetypo/build/subs","./__archetypo/child-archetypo","./__archetypo/methods/data","./__archetypo/methods/arch-evaluate/index","./__archetypo/methods/index"],function(e,r,t){var o=e("lodash"),a=e("jquery"),n=e("scope"),i=(e("q"),e("./__archetypo/build/subs")),s=e("./__archetypo/child-archetypo"),h={enumerable:!1},c=t.exports=n.extend({initialize:function(){n.prototype.initialize.apply(this,arguments),this.archInit().then(o.bind(function(){var e=i.call(this);this.ready=o.bind(e.done,e)},this))},archInit:function(e){this.childArchetypo=o.bind(s,this);var r=this.el;if(!(r&&0!==r.length&&r instanceof a))throw new Error("No el on for archetypo constructor.");this.el.data("archetypo",this);var t=this.archData(),n=this.archEvaluate(t);return e||(n=n.then(o.bind(i,this))),n.fail(this.error),this.promise=n,this.ready=o.bind(n.done,n),n},archSelector:"[data-archetypo]",error:function(e){throw console.log("Archetypo error handler. Override for better error handling."),console.log(e.message),e}},h);c.assignProto(e("./__archetypo/methods/data"),h),c.assignProto(e("./__archetypo/methods/arch-evaluate/index"),h),c.assignProto(e("./__archetypo/methods/index"),h),a.prototype.archetypo=function(){var e=this.data("archetypo");return e?e:c({el:this})}});