//     archetypo
//     (c) simonfan
//     archetypo is licensed under the MIT terms.

define("__archetypo/parse/value",["require","exports","module"],function(e,r,t){function o(e){return"["+e+"]"}function n(e){var r={};return e?e[2]?(r.type="invocation",r.priority=""===e[1]?"0":e[1],r.method=e[2],r.value=o(e[3])):e[4]&&(r.type="value",r.value=e[4]):r.type="empty",r}var a="\\s*",u="(?:(\\d*)!)?",i="([\\w$.\\-]*)",c=":"+a+"(.*)"+a,s=["^",a,"(?:",u,a,i,a,c,"|","(.*?)",")",a,"$"].join(""),l=new RegExp(s);t.exports=function(e){if(_.isString(e)){var r=e.match(l);return n(r)}return console.log(e),{type:"value",value:e}}}),define("__archetypo/build/data",["require","exports","module","lodash","jquery-meta-data","../parse/value"],function(e,r,t){var o=e("lodash"),n=(e("jquery-meta-data"),e("../parse/value")),a={prefix:"arch",parse:n,replace:!1};t.exports=function(e,r){return o.defaults(r,a),e.metaData(r)}}),define("__archetypo/auxiliary",["require","exports","module","lodash"],function(e,r){e("lodash");r.camelCase=function(e){return e.replace(/-(.)/g,function(e,r){return r.toUpperCase()})},r.closestAncestor=function(e,r){return e.parent().closest(r)}}),define("__archetypo/build/evaluation/invoke",["require","exports","module","q","deep","../../auxiliary"],function(e,r,t){var o=e("q"),n=(e("deep"),e("../../auxiliary"));t.exports=function(e,r){var t=n.camelCase(r.method),a=e.evaluate("$"+t);console.log(t),console.log(r.value);var u=e.invoke(a,r.value);return o.isPromise(u)?u:o(u)}}),define("__archetypo/build/evaluation/index",["require","exports","module","lodash","q","_q","./invoke"],function(e,r,t){function o(e,r){console.log(r);var t=n.reduce(r,function(r,t,o){return"value"===t.type&&(r[o]=e.evaluate(t.value)),r},{});e.assign(t);var o=n.pick(r,function(e){return"invocation"===e.type});return u.mapValues(o,function(r,t){return i(e,r,t)}).then(function(r){return e.assign(r),e})}var n=e("lodash"),a=e("q"),u=e("_q"),i=e("./invoke");t.exports=function(e,r){var t=n.unique(n.pluck(r,"priority")).sort(function(e,r){return e-r}),u=n.map(t,function(t){var a=n.pick(r,function(e){return e.priority===t});return n.partial(o,e,a)});console.log(t),console.log(u);var i=n.reduce(u,function(e,r){return e.then(r)},a());return i.then(function(){return e})}}),define("__archetypo/arch-scope/methods",["require","exports","module","lodash","q","deep"],function(e,r){var t=e("lodash"),o=e("q"),n=e("deep");r.load=function(r,a){var u=o.defer();return t.isString(r)?a?e([r],function(e){u.resolve(n.get(e,a),u.reject)}):e([r],u.resolve,u.reject):t.isArray(r)&&e(r,function(){var e=t.toArray(arguments);u.resolve(a?t.map(e,function(e){return n.get(e,a)}):e)},u.reject),u.promise,u.promise},r.summon=function(e){var r=Array.prototype.slice.call(arguments,1);return r=r&&r.length>0?r:[this],this.load(e).then(t.bind(function(e){e.apply(this,r)},this))},r.l=r.load,r.s=r.summon}),define("__archetypo/arch-scope/index",["require","exports","module","jquery","scope","./methods"],function(e,r,t){var o=e("jquery"),n=e("scope"),a={enumerable:!1},u=t.exports=n.extend();u.assignProto(e("./methods"),a),o.prototype.archetypo=function(){var e=this.data("archetypo");return e?e:u({el:this})}}),define("__archetypo/build/scope",["require","exports","module","../arch-scope/index","../auxiliary"],function(e,r,t){var o=e("../arch-scope/index"),n=e("../auxiliary");t.exports=function(e,r){var t,a={el:e},u=n.closestAncestor(e,r.selector);return t=u&&0!==u.length?u.data("archetypo").create(a):o(_.assign(r.rootScope,a)),e.data("archetypo",t),t}}),define("archetypo",["require","exports","module","jquery","lodash","q","./__archetypo/build/data","./__archetypo/build/evaluation/index","./__archetypo/build/scope"],function(e,r,t){function o(e,r){var t=a(e).find(r.selector),o=u.map(t,function(e){return n(a(e),r)});return i.all(o)}function n(e,r){var t=e.data("archetypo-promise");if(!t){r=r||{},u.defaults(r,p);var t=i(c(e,r)).then(function(t){var o=l(e,r);return e.data("archetypo",o),s(o,t,r)}).then(function(r){e.data("archetypo").assign(r)}).then(function(){return o(e,r)}).then(function(){return e.data("archetypo")});e.data("archetypo-promise",t)}return t}var a=e("jquery"),u=e("lodash"),i=e("q"),c=e("./__archetypo/build/data"),s=e("./__archetypo/build/evaluation/index"),l=e("./__archetypo/build/scope"),p={selector:"[data-archetypo]",rootScope:{}};t.exports=n});