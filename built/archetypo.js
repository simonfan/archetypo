//     archetypo
//     (c) simonfan
//     archetypo is licensed under the MIT terms.

define("__archetypo/parse/value",["require","exports","module"],function(e,t,r){function a(e){return"["+e+"]"}function o(e){var t={};return e?e[2]?(t.type="invocation",t.priority=""===e[1]?"0":e[1],t.method=e[2],t.value=a(e[3])):e[4]&&(t.type="value",t.value=e[4]):t.type="empty",t}var n="\\s*",i="(?:(\\d*)!)?",s="([\\w$\\-]*)",h=":"+n+"(.*)"+n,u=["^",n,"(?:",i,n,s,n,h,"|","(.*?)",")",n,"$"].join(""),c=new RegExp(u);r.exports=function(e){var t=e.match(c);return o(t)}}),define("__archetypo/methods/data",["require","exports","module","lodash","jquery-meta-data","../parse/value"],function(e,t){var r=e("lodash"),a=(e("jquery-meta-data"),e("../parse/value"));t.archData=function(){var e=r.toArray(arguments),t=e.shift()||{};return r.defaults(t,this.archDataOptions),e.unshift(t),this.el.metaData.apply(this.el,e)},t.archDataOptions={prefix:"arch",parse:a,replace:!1}}),define("__archetypo/helpers",["require","exports","module","lodash"],function(e,t){e("lodash");t.camelCase=function(e){return e.replace(/-(.)/g,function(e,t){return t.toUpperCase()})}}),define("__archetypo/methods/arch-evaluate/invoke",["require","exports","module","q","../../helpers"],function(e,t,r){var a=e("q"),o=e("../../helpers");r.exports=function(e){var t=o.camelCase(e.method),r=this.invoke(t,e.value);return r=a.isPromise(r)?r:a(r),r.fail(this.error),r}}),define("__archetypo/methods/arch-evaluate/index",["require","exports","module","lodash","q","_q","./invoke"],function(e,t){function r(e){var t=a.reduce(e,function(e,t,r){return"value"===t.type&&(e[r]=this.evaluate(t.value)),e},{},this);this.assign(t);var r=a.pick(e,function(e){return"invocation"===e.type});return n.mapValues(r,i,this).then(a.bind(function(e){return this.assign(e),this},this)).fail(this.error)}var a=e("lodash"),o=e("q"),n=e("_q"),i=e("./invoke");t.archEvaluate=function(e){var t=a.unique(a.pluck(e,"priority")).sort(function(e,t){return e-t}),n=a.map(t,function(t){var o=a.pick(e,function(e){return e.priority===t});return a.partial(a.bind(r,this),o)},this),i=a.reduce(n,function(e,t){return e.then(t)},o()),s=this;return i.then(function(){return s}).fail(this.error),i}}),define("__archetypo/methods/index",["require","exports","module","lodash","q","deep"],function(e,t){var r=e("lodash"),a=e("q"),o=e("deep");t.load=function(t,n){var i=a.defer();return r.isString(t)?n?e([t],function(e){i.resolve(o.get(e,n))}):e([t],i.resolve):r.isArray(t)&&e(t,function(){var e=r.toArray(arguments);i.resolve(n?r.map(e,function(e){return o.get(e,n)}):e)}),i.promise},t.summon=function(e){var t=Array.prototype.slice.call(arguments,1);return t=t&&t.length>0?t:[this],this.load(e).done(r.bind(function(e){e.apply(this,t)},this))},t.l=t.load,t.s=t.summon}),define("__archetypo/methods/subs",["require","exports","module","q","_q","jquery"],function(e,t){function r(e){var t=o(e),r=t.data("archetypo");if(!r){var a=t.parent().closest(this.archSelector),n=a.data("archetypo");r=n.create({el:t})}return r.promise}var a=e("q"),o=(e("_q"),e("jquery"));t.archSubs=function(){var e=this.el.find(this.archSelector),t=_.map(e,r,this),o=this;return a.all(t).then(function(){return o})}}),define("__archetypo/methods/create",["require","exports","module","scope"],function(e,t){var r=e("scope");t.create=function(e){var t=r.prototype.create.call(this,e);return t.archInit(),t}}),define("archetypo",["require","exports","module","lodash","jquery","scope","q","./__archetypo/methods/data","./__archetypo/methods/arch-evaluate/index","./__archetypo/methods/index","./__archetypo/methods/subs","./__archetypo/methods/create"],function(e,t,r){var a=e("lodash"),o=e("jquery"),n=e("scope"),i=(e("q"),{enumerable:!1}),s=r.exports=n.extend({initialize:function(){n.prototype.initialize.apply(this,arguments),this.archInit()},archInit:function(){var e=this.el;if(!(e&&0!==e.length&&e instanceof o))throw new Error("No el on for archetypo constructor.");this.el.data("archetypo",this);var t=this.archData(),r=this.archEvaluate(t).then(a.bind(this.archSubs,this)).fail(this.error);this.ready=a.bind(r.done,r)},archSelector:"[data-archetypo]",error:function(e){throw console.log("archerrro"),console.log(e.message),e}},i);s.assignProto(e("./__archetypo/methods/data"),i),s.assignProto(e("./__archetypo/methods/arch-evaluate/index"),i),s.assignProto(e("./__archetypo/methods/index"),i),s.assignProto(e("./__archetypo/methods/subs"),i),s.assignProto(e("./__archetypo/methods/create"),i),o.prototype.archetypo=function(){var e=this.data("archetypo");return e?e:s({el:this})}});