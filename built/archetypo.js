//     archetypo
//     (c) simonfan
//     archetypo is licensed under the MIT terms.

define("__archetypo/registry/index",["require","exports","module","lodash","lowercase-backbone","backbone.model.tree"],function(e,t,i){var r=(e("lodash"),e("lowercase-backbone")),n=e("backbone.model.tree"),a=i.exports=r.model.extend(n.prototype);a.proto({initialize:function(){r.model.prototype.initialize.apply(this,arguments),n.prototype.initialize.apply(this,arguments)},descendantItems:function(e){var t=this.selectDescendants(e);return t.map(function(e){return e.get("item")})}})}),define("__archetypo/view/initialize/render",["require","exports","module","lodash","q"],function(e,t,i){function r(t){var i=a.defer();this.$el=n.isObject(t.$el)?t.$el:t.el;var r=this.elData();if(r.html)e(["text!"+r.html],n.bind(function(e){this.$el.html(e),i.resolve()},this));else{var o=t.html||this.html;o&&(this.$el.html(o),i.resolve())}return i.promise}var n=e("lodash"),a=e("q");i.exports=function(){return this.renderPromise||(this.renderPromise=r.apply(this,arguments)),this.renderPromise}}),define("__archetypo/view/initialize/register",["require","exports","module","lodash","../../registry/index"],function(e,t,i){var r=(e("lodash"),e("../../registry/index"));i.exports=function(e){e=e||{};var t=this.elData()||{};t.id=t.id||t.archId||this.cid,t.item=this,this.ancestorView=e.ancestorView||!1,this.registry=this.ancestorView?this.ancestorView.registry.addBranch(t):r(t)}}),define("__archetypo/view/initialize/subviews",["require","exports","module","lodash","jquery"],function(e,t,i){var r=e("lodash"),n=e("jquery");i.exports=function(e){var t=e.app,i=this.$el.find("[data-builder]");r.each(i,r.bind(function(e){var i=n(e),a=i.data(),o=a.builder;o=r.isString(o)?o.split(/\s+/):[],o=r.compact(o),r.each(o,r.bind(function(e){if(!a["instantiated_"+e]){var n=t.builder(e),o=r.extend(a,{el:i,ancestorView:this,app:t});n(o),i.data("instantiated_"+e,!0)}},this))},this))}}),define("__archetypo/view/el-data",["require","exports","module","lodash"],function(e,t){function i(e){var t=e.split(n);return t=r.compact(t),1===t.length?t[0]:t}var r=e("lodash"),n=/\s+/;t.elData=function(){var e=this.$el;if(0===arguments.length)return r.mapValues(e.data(),function(e){return r.isString(e)?i(e):e});if(1===arguments.length&&r.isString(arguments[0])){var t=e.data(arguments[0]);return r.isString(t)?i(t):t}return e.data.apply(e,arguments),this}}),define("__archetypo/view/index",["require","exports","module","lodash","dockable-view","../registry/index","./initialize/render","./initialize/register","./initialize/subviews","./el-data"],function(e,t,i){var r=e("lodash"),n=e("dockable-view"),a=(e("../registry/index"),e("./initialize/render")),o=e("./initialize/register"),s=e("./initialize/subviews"),l=i.exports=n.extend(function(e){arguments[0]=e||{};var t=Array.prototype.slice.call(arguments);this.app=e.app,this.render(e).then(r.bind(function(){n.prototype.initialize.apply(this,t),s.apply(this,t)},this)),o.apply(this,t)});l.proto({render:a,views:function(e){return r.isString(e)?this.registry.descendantItems({id:e}).take(1).toArray()[0]:this.registry.descendantItems(e)}}),l.proto(e("./el-data"))}),define("__archetypo/router/format",["require","exports","module","lodash"],function(e,t,i){function r(e){return e.replace(/(\(|\(.*:|:|\)|\*)/,"")}var n=(e("lodash"),/\((.*?)\)/g),a=/(\(\?)?:\w+/g,o=/\*\w+/g;i.exports=function(e,t){return e=e.replace(a,function(e){var i=r(e);return t[i]?t[i]:e}),e=e.replace(o,function(e){var i=r(e);return t[i]?t[i]:""}),e.replace(n,"")}}),define("__archetypo/router/index",["require","exports","module","lodash","lowercase-backbone","./format"],function(e,t,i){{var r=e("lodash"),n=e("lowercase-backbone").router,a=e("./format");i.exports=n.extend({initialize:function(){this.routeFormats={}},route:function(e,t){return r.isString(t)&&(this.routeFormats[t]=e),n.prototype.route.apply(this,arguments)},navigate:function(e,t,i){var r=this.routeFormats[e];if(r){var o=a(r,t);return n.prototype.navigate.call(this,o,i)}return n.prototype.navigate.apply(this,arguments)}})}}),define("archetypo",["require","exports","module","subject","lowercase-backbone","dockable-view","q","lodash","jquery","./__archetypo/view/index","./__archetypo/router/index","./__archetypo/view/initialize/register","./__archetypo/view/initialize/subviews"],function(e,t,i){var r=(e("subject"),e("lowercase-backbone")),n=e("dockable-view"),a=(e("q"),e("lodash"),e("jquery")),o=e("./__archetypo/view/index"),s=e("./__archetypo/router/index"),l=e("./__archetypo/view/initialize/register"),u=e("./__archetypo/view/initialize/subviews"),d=i.exports=o.extend(r.router.prototype).extend(s.prototype);d.proto({initialize:function(){s.prototype.initialize.apply(this,arguments),this.isApp=!0,this.builders={"default":o}},builder:function(e,t){if(2===arguments.length)return this.builders[e]=this.builders["default"].extend(t),this.builders[e];if(1===arguments.length){var i=this.builders[e];if(!i)throw new Error('No builder "'+e+'" defined in app.');return i}},build:function(e){if(arguments[0]=e||{},arguments[0].app=this,n.prototype.initialize.apply(this,arguments),!this.$el)throw new Error("No DOM element in archetypo.");l.apply(this,arguments),u.apply(this,arguments)},start:function(e){return e=e||{},e.el=e.el||a("[data-archetypo],[archetypo]"),this.build(e),r.history.start(e),this}})});