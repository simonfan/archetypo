//     archetypo
//     (c) simonfan
//     archetypo is licensed under the MIT terms.

define("__archetypo/parse/value",["require","exports","module"],function(e,r,t){function n(e){return"["+e+"]"}function a(e){var r={};return e?e[2]?(r.type="invocation",r.priority=""===e[1]?"0":e[1],r.method=e[2],r.value=n(e[3])):e[4]&&(r.type="value",r.priority=e[1],r.value=e[4]):r.type="empty",r}var o="\\s*",u="(?:(\\d*)!)?",i="([\\w$.\\-/]*)",c=":"+o+"(.*)"+o,p=["^",o,u,o,"(?:",i,o,c,"|","(.*?)",")",o,"$"].join(""),s=new RegExp(p);t.exports=function(e){if(_.isString(e)){var r=e.match(s);return a(r)}return{type:"value",value:e}}}),define("__archetypo/build/data",["require","exports","module","lodash","jquery-meta-data","../parse/value"],function(e,r,t){var n=e("lodash"),a=(e("jquery-meta-data"),e("../parse/value")),o={prefix:"arch",parse:a,replace:!1};t.exports=function(e,r){return n.defaults(r,o),e.metaData(r)}}),define("__archetypo/auxiliary",["require","exports","module","lodash"],function(e,r){e("lodash");r.camelCase=function(e){return e.replace(/-(.)/g,function(e,r){return r.toUpperCase()})},r.closestAncestor=function(e,r){return e.parent().closest(r)}}),define("__archetypo/build/evaluation/invoke",["require","exports","module","q","deep","../../auxiliary"],function(e,r,t){function n(e,r){var t=e.evaluate("$"+r);return _.isFunction(t)?a(t):e.load(r)}var a=e("q"),o=(e("deep"),e("../../auxiliary"));t.exports=function(e,r){var t=o.camelCase(r.method);return n(e,t).then(function(t){var n,o=e.evaluate(r.value);return n=o&&0!==o.length?t.apply(e,o):t.call(e,e),a.isPromise(n)?n:a(n)})}}),define("__archetypo/build/evaluation/index",["require","exports","module","lodash","q","_q","./invoke"],function(e,r,t){function n(e,r){var t=a.reduce(r,function(r,t,n){return"value"===t.type&&(r[n]=e.evaluate(t.value)),r},{});e.assign(t);var n=a.pick(r,function(e){return"invocation"===e.type});return u.mapValues(n,function(r,t){return i(e,r,t)}).then(function(r){return e.assign(r),e})}var a=e("lodash"),o=e("q"),u=e("_q"),i=e("./invoke");t.exports=function(e,r){var t=a.unique(a.pluck(r,"priority")).sort(function(e,r){return e-r}),u=a.map(t,function(t){var o=a.pick(r,function(e){return e.priority===t});return a.partial(n,e,o)}),i=a.reduce(u,function(e,r){return e.then(r)},o());return i.then(function(){return e})}}),define("__archetypo/arch-scope/methods",["require","exports","module","lodash","q","deep","scope"],function(e,r){{var t=e("lodash"),n=e("q"),a=e("deep");e("scope")}r.load=function(r,o){var u=n.defer();return t.isString(r)?o?e([r],function(e){u.resolve(a.get(e,o),u.reject)}):e([r],u.resolve,u.reject):t.isArray(r)&&e(r,function(){var e=t.toArray(arguments);u.resolve(o?t.map(e,function(e){return a.get(e,o)}):e)},u.reject),u.promise,u.promise},r.l=r.load}),define("__archetypo/arch-scope/index",["require","exports","module","jquery","scope","./methods"],function(e,r,t){var n=e("jquery"),a=e("scope"),o={enumerable:!1},u=t.exports=a.extend();u.assignProto(e("./methods"),o),n.prototype.archetypo=function(){var e=this.data("archetypo");return e?e:u({el:this})}}),define("__archetypo/build/scope",["require","exports","module","../arch-scope/index","../auxiliary"],function(e,r,t){var n=e("../arch-scope/index"),a=e("../auxiliary");t.exports=function(e,r,t){var t=t||{};t.el=e;var o,u=a.closestAncestor(e,r.selector);return o=u&&0!==u.length?u.data("archetypo").create(t):n(t),e.data("archetypo",o),o}}),define("archetypo",["require","exports","module","jquery","lodash","q","./__archetypo/build/data","./__archetypo/build/evaluation/index","./__archetypo/build/scope"],function(e,r,t){function n(e,r){var t=o(e).find(r.selector),n=u.map(t,function(e){return a(o(e),null,r)});return i.all(n)}function a(e,r,t){var a=e.data("archetypo-promise");if(!a){t=t||{},u.defaults(t,l);var a=i(c(e,t)).then(function(n){var a=s(e,t,r);return e.data("archetypo",a),p(a,n,t)}).then(function(){return n(e,t)}).then(function(){return e.data("archetypo")});e.data("archetypo-promise",a)}return a}var o=e("jquery"),u=e("lodash"),i=e("q"),c=e("./__archetypo/build/data"),p=e("./__archetypo/build/evaluation/index"),s=e("./__archetypo/build/scope"),l={selector:"[data-archetypo]"};a.setDefaults=function(e,r){u.isObject(e)?u.each(e,function(e,r){l[r]=e}):l[e]=r},t.exports=a});